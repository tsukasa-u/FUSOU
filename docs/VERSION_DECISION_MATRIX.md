# Version Management Decision Guide

## Quick Reference: 各案の一覧比較

### 案の全体像

```
┌─────────────────────────────────────────────────────────────────────┐
│                    6つの実装案                                        │
├──────────┬──────────────────────┬──────────────────┬───────────────┤
│  案      │  コンセプト           │  難易度          │  推奨度       │
├──────────┼──────────────────────┼──────────────────┼───────────────┤
│ A-1      │ v0形式統一           │ 中               │ ⭐⭐      │
│ A-2      │ v1形式統一（v0→v1）  │ 中               │ ⭐⭐⭐    │
│ B-1      │ 階層化（並行管理）    │ 小（推奨）       │ ⭐⭐⭐⭐⭐ │
│ B-2      │ 互換性マッピング      │ 小               │ ⭐⭐⭐⭐  │
│ C-1      │ 現状維持             │ なし             │ ⭐          │
│ C-2      │ 改名による明示化     │ 大               │ ⭐⭐      │
└──────────┴──────────────────────┴──────────────────┴───────────────┘
```

---

## 比較表：全項目

### 基本仕様

| 項目 | A-1 | A-2 | **B-1** | B-2 | C-1 | C-2 |
|------|-----|-----|---------|-----|-----|-----|
| **DATABASE_TABLE_VERSION の扱い** | シングルソース | 廃止 | 記録のみ | 記録のみ | そのまま | そのまま |
| **SCHEMA_VERSION の扱い** | 廃止 | シングルソース | 記録のみ | 記録のみ | そのまま | リネーム |
| **バージョン体系** | 0.4, 0.5... | v0, v1, v2... | 0.4+v1 併用 | 0.4+v1 併用 | 0.4+v1 混在 | 0.4+DATA_FMT |
| **Feature flag** | 不要 | 必須 | 必須 | 必須 | 必須 | 必須 |

---

### 実装コスト

| 項目 | A-1 | A-2 | **B-1** | B-2 | C-1 | C-2 |
|------|-----|-----|---------|-----|-----|-----|
| **コード修正行数** | 200+ | 300+ | 100+ | 200+ | 0 | 500+ |
| **D1 スキーマ変更** | なし | なし | あり | あり | なし | なし |
| **テスト工数** | 中 | 中 | 低 | 高 | 低 | 低 |
| **ドキュメント作成** | 低 | 低 | **中** | 高 | **中** | 低 |
| **後方互換性維持** | 困難 | 困難 | **容易** | 容易 | **容易** | 中 |

---

### 機能比較

| 機能 | A-1 | A-2 | **B-1** | B-2 | C-1 | C-2 |
|------|-----|-----|---------|-----|-----|-----|
| **ゲーム版管理** | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ |
| **Avro 形式管理** | ❌ | ✅ | ✅ | ✅ | ✅ | ✅ |
| **両者の分離** | ❌ | ❌ | **✅** | **✅** | ❌ | ✅ |
| **互換性チェック** | ❌ | ❌ | 可（別実装） | **✅** | ❌ | ❌ |
| **V2対応可能** | 困難 | 容易 | **容易** | **容易** | 困難 | 容易 |

---

### 将来対応

| シナリオ | A-1 | A-2 | **B-1** | B-2 | C-1 | C-2 |
|--------|-----|-----|---------|-----|-----|-----|
| **ゲーム 0.5 更新（互換）** | 自動対応 | 自動対応 | **自動対応** | **自動対応** | 手動対応 | 手動対応 |
| **ゲーム 0.5 更新（破棄的）** | v1 新規作成 | v2 新規作成 | **v2 新規作成** | **v2 新規作成** | 大量修正 | 大量修正 |
| **Avro 形式最適化** | 困難 | 容易 | **容易** | **容易** | 困難 | 容易 |
| **旧データ読込** | 困難 | 中 | **容易** | **容易** | 中 | 中 |

---

## 意思決定フロー

```
┌─ Q1: コード修正をできるだけ避けたい？
│      ├─ YES → C-1 推奨（現状維持）
│      └─ NO ↓
│
├─ Q2: ゲームデータ版と Avro 形式を分離管理したい？
│      ├─ YES → B-1 または B-2 推奨 ⭐
│      │         └─ 互換性チェック機能が必要？
│      │            ├─ YES → B-2
│      │            └─ NO → B-1 推奨 ⭐⭐⭐
│      │
│      └─ NO ↓
│
├─ Q3: 従来の 0.4 体系を保持したい？
│      ├─ YES → A-1 推奨
│      └─ NO → A-2 推奨
```

---

## 各案の詳細比較

### 案A-1: v0形式統一

**メリット:**
- ✅ シングルソース（0.4 ひとつ）
- ✅ 自動同期（ゲーム更新で追従）
- ✅ 統一体系（0.4, 0.5, 0.6...）
- ✅ Feature 不要（実装簡潔）

**デメリット:**
- ❌ Avro 形式変更に対応できない
- ❌ 既存の SCHEMA_VERSION コード削除が大量
- ❌ 将来 v2 必要時に修正困難

**データフロー:**
```
FUSOU-APP
  ↓ version="0.4"（DATABASE_TABLE_VERSION）
  ↓
FUSOU-WORKFLOW
  ↓ D1 buffer_logs.version = "0.4"
  ↓
R2 path: 0.4/{period}/{table}.avro
```

**結論:** 現在の仕様に適していない（v1/v2 系統が必要）

---

### 案A-2: v1形式統一（推奨度★★★）

**メリット:**
- ✅ Feature flag で版管理
- ✅ コンパイル時エラーチェック
- ✅ 新型番体系（v0, v1, v2...）
- ✅ 既存コード構造を活かせる

**デメリット:**
- ❌ "0.4" から "v0" への移行工数
- ❌ 既存ログ解釈が複雑
- ❌ ゲーム版と Avro 版が完全一体

**データフロー:**
```
FUSOU-APP
  ↓ version="v0"（SCHEMA_VERSION feature）
  ↓
FUSOU-WORKFLOW
  ↓ D1 buffer_logs.version = "v0"
  ↓
R2 path: v0/{period}/{table}.avro
```

**実装例:**
```rust
// schema_version.rs
#[cfg(feature = "schema_v0")]
pub const SCHEMA_VERSION: &str = "v0";
pub const DATABASE_TABLE_VERSION: &str = "v0";

#[cfg(feature = "schema_v1")]
pub const SCHEMA_VERSION: &str = "v1";
pub const DATABASE_TABLE_VERSION: &str = "v1";

// models/env_info.rs
pub fn new_ret_uuid(...) {
    let new_data: EnvInfo = EnvInfo {
        version: SCHEMA_VERSION.to_string(),  // "v0" or "v1"
        ...
    };
}
```

**いつ選ぶ？** 
- バージョン体系をクリーンアップしたい
- "0.4" から "v0" への移行が容易な場合

---

### 案B-1: 階層化（推奨 ⭐⭐⭐⭐⭐）

**メリット:**
- ✅ ゲーム版と Avro 版を完全分離
- ✅ 段階的導入可能
- ✅ 後方互換性が最高
- ✅ 将来の柔軟性が最高
- ✅ コード修正が最小限

**デメリット:**
- ⚠️  2つのバージョンを追跡（複雑度+1）
- ⚠️  D1 スキーマに新フィールド必要
- ⚠️  ドキュメントメンテが重要

**データフロー:**
```
FUSOU-APP
  ↓ schema_version="v1", database_table_version="0.4"
  ↓
FUSOU-WORKFLOW
  ↓ D1 buffer_logs.schema_version="v1"
  ↓         buffer_logs.database_table_version="0.4"
  ↓
R2 path: v1/{period}/{table}.avro
R2 metadata: database_version=0.4
```

**実装例:**
```typescript
// buffer-consumer.ts
interface BufferLogRecord {
    schema_version: string;           // "v1", "v2"
    database_table_version: string;   // "0.4", "0.5"
}

// cron.ts（変更なし）
const schemaVersion = record.schema_version;  // "v1"
const filePath = `${schemaVersion}/${periodTag}/${tableName}.avro`;

// 将来：ゲーム 0.5 対応時
{
    schema_version: "v1",              // v1 で 0.5 に対応
    database_table_version: "0.5"     // ← ゲーム版が進んだ
}
```

**拡張性：**
```
// ゲーム 0.5 で破棄的変更が発生した場合
{
    schema_version: "v2",              // v2 新規実装
    database_table_version: "0.5"     // v2 は 0.5+ 対応
}
// v1 と v2 が R2 で混在可能
```

**いつ選ぶ？** 
- ✅ ゲームとアーカイブの独立進化を許容したい
- ✅ 将来の複数バージョン共存に対応したい
- ✅ バージョン管理の複雑度は許容できる

---

### 案B-2: 互換性マッピング（推奨度★★★★）

**メリット:**
- ✅ B-1 の機能 + 互換性チェック
- ✅ ログで問題検出可能
- ✅ テスト容易

**デメリット:**
- ❌ 実装コストが B-1 より高い
- ❌ VERSION_MAP メンテが煩雑

**いつ選ぶ？** 
- 互換性検証が重要な運用
- 複数バージョンが混在している

---

### 案C-1: 現状維持（推奨度★）

**メリット:**
- ✅ コード変更ゼロ
- ✅ リスク最小
- ✅ 迅速デプロイ可能

**デメリット:**
- ❌ 技術的負債蓄積
- ❌ ドキュメント同期が重要
- ❌ 後から統一は困難

**いつ選ぶ？** 
- 今すぐ決定できない
- ゲーム 0.5 まで先延ばし可能

---

### 案C-2: 改名（推奨度★★）

**メリット:**
- ✅ 名前で一発区別可能
- ✅ コンセプト明確化

**デメリット:**
- ❌ リネーム工数大（500+行）
- ❌ 全 Ts/Rs コード修正

**いつ選ぶ？** 
- 命名を重視する設計思想
- リネーム工数が許容できる場合

---

## 段階的採用パス

### Phase 0（今すぐ）：ドキュメント充実
```
現在のコード = C-1（現状維持）
追加 = ドキュメント：VERSION_COMPATIBILITY.md
内容 = 「SCHEMA_VERSION v1 は DATABASE_TABLE_VERSION 0.4 対応」
```

### Phase 1（1-2週間）：B-1 準備
```
D1 スキーマ拡張：database_table_version カラム追加
コード修正：buffer-consumer.ts に database_table_version 記録
テスト：E2E テストで両バージョン確認
```

### Phase 2（1-2ヶ月後）：完全な B-1 運用
```
互換性マトリックス完成
FUSOU-WORKFLOW で両バージョンを活用
ドキュメント：COMPATIBILITY_MATRIX.md 完成
```

### Phase 3（ゲーム 0.5 確定時）：v2 対応判定
```
B-1 基盤で v2 を追加
既存 v1 データは v1/{period}/{table} に保存
新 v2 データは v2/{period}/{table} に保存
```

---

## 推奨意思決定フロー

```
今日の決定
  ↓
実装をしたいか？
  ├─ NO → C-1 + ドキュメント整備 → 次フェーズで再判定
  │
  └─ YES ↓
     ゲームと Avro を分離したい？
       ├─ NO → A-2（全面 v1 統一）
       │
       └─ YES ↓
          互換性チェックが必要？
            ├─ NO → B-1 ⭐⭐⭐ 推奨
            │       └─ 最適なバランス
            │
            └─ YES → B-2 ⭐⭐⭐⭐
                    └─ 検証厳密重視
```

---

## 最終推奨: 案 B-1（階層化）

### 理由

1. **短期実装が容易** - D1 カラム追加 + ts コード修正
2. **後方互換性** - 旧データ読取が容易
3. **将来対応性** - v2、v3... が無理なく追加可能
4. **複雑度が許容範囲** - 2つのバージョンは管理可能
5. **長期保守性** - 技術的負債が最小

### 実装スケジュール（概算）
- **設計**: 1日
- **コード修正**: 2-3日
- **テスト**: 1-2日
- **ドキュメント**: 1日
- **合計**: 1週間
