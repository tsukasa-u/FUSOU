<!DOCTYPE html>
        <html>
        <head>
            <meta charset="UTF-8">
            <title>&#x5b9f;&#x88c5;&#x6e08;&#x307f;&#x9805;&#x76ee;&#x3068;&#x4eca;&#x5f8c;&#x306e;&#x4f5c;&#x696d;&#xff08;Manual Sync &#x5b9f;&#x88c5;&#x307e;&#x3068;&#x3081;&#xff09;</title>
            <style>
/* From extension vscode.github */
/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/

.vscode-dark img[src$=\#gh-light-mode-only],
.vscode-light img[src$=\#gh-dark-mode-only],
.vscode-high-contrast:not(.vscode-high-contrast-light) img[src$=\#gh-light-mode-only],
.vscode-high-contrast-light img[src$=\#gh-dark-mode-only] {
	display: none;
}

</style>
    <script type="module">
      import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
      mermaid.initialize({ startOnLoad: true });
    </script>
            <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex/dist/katex.min.css">
<link href="https://cdn.jsdelivr.net/npm/katex-copytex@latest/dist/katex-copytex.min.css" rel="stylesheet" type="text/css">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Microsoft/vscode/extensions/markdown-language-features/media/markdown.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Microsoft/vscode/extensions/markdown-language-features/media/highlight.css">
<style>
            body {
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe WPC', 'Segoe UI', system-ui, 'Ubuntu', 'Droid Sans', sans-serif;
                font-size: 14px;
                line-height: 1.6;
            }
        </style>
        <style>
.task-list-item {
    list-style-type: none;
}

.task-list-item-checkbox {
    margin-left: -20px;
    vertical-align: middle;
    pointer-events: none;
}
</style>
<style>
:root {
  --color-note: #0969da;
  --color-tip: #1a7f37;
  --color-warning: #9a6700;
  --color-severe: #bc4c00;
  --color-caution: #d1242f;
  --color-important: #8250df;
}

</style>
<style>
@media (prefers-color-scheme: dark) {
  :root {
    --color-note: #2f81f7;
    --color-tip: #3fb950;
    --color-warning: #d29922;
    --color-severe: #db6d28;
    --color-caution: #f85149;
    --color-important: #a371f7;
  }
}

</style>
<style>
.markdown-alert {
  padding: 0.5rem 1rem;
  margin-bottom: 16px;
  color: inherit;
  border-left: .25em solid #888;
}

.markdown-alert>:first-child {
  margin-top: 0
}

.markdown-alert>:last-child {
  margin-bottom: 0
}

.markdown-alert .markdown-alert-title {
  display: flex;
  font-weight: 500;
  align-items: center;
  line-height: 1
}

.markdown-alert .markdown-alert-title .octicon {
  margin-right: 0.5rem;
  display: inline-block;
  overflow: visible !important;
  vertical-align: text-bottom;
  fill: currentColor;
}

.markdown-alert.markdown-alert-note {
  border-left-color: var(--color-note);
}

.markdown-alert.markdown-alert-note .markdown-alert-title {
  color: var(--color-note);
}

.markdown-alert.markdown-alert-important {
  border-left-color: var(--color-important);
}

.markdown-alert.markdown-alert-important .markdown-alert-title {
  color: var(--color-important);
}

.markdown-alert.markdown-alert-warning {
  border-left-color: var(--color-warning);
}

.markdown-alert.markdown-alert-warning .markdown-alert-title {
  color: var(--color-warning);
}

.markdown-alert.markdown-alert-tip {
  border-left-color: var(--color-tip);
}

.markdown-alert.markdown-alert-tip .markdown-alert-title {
  color: var(--color-tip);
}

.markdown-alert.markdown-alert-caution {
  border-left-color: var(--color-caution);
}

.markdown-alert.markdown-alert-caution .markdown-alert-title {
  color: var(--color-caution);
}

</style>
        
        </head>
        <body class="vscode-body vscode-light">
            <h2 id="実装済み項目と今後の作業manual-sync-実装まとめ">実装済み項目と今後の作業（Manual Sync 実装まとめ）</h2>
<p>以下はリポジトリに既に追加済みの実装と、あなた（運用者/開発者）が行う必要がある具体的な手順をまとめたドキュメントです。</p>
<p><strong>目的</strong>: クライアントから手動でスナップショット（fleet）を送信 → ペイロードを Cloudflare R2 に保存 → Supabase にメタデータを保持 → 短縮 URL を通じてエッジで配信（ETag / 304 / キャッシュ）</p>
<hr>
<p><strong>実装済み（リポジトリ内の主要ファイル）</strong></p>
<ul>
<li><code>docs/sql/supabase_fleets_schema.sql</code> — Supabase 用の <code>fleets</code> テーブル定義と RLS ポリシー例。</li>
<li><code>packages/FUSOU-WEB/src/pages/api/fleet/snapshot.ts</code> — サンプルの <code>POST /api/fleet/snapshot</code> ハンドラ（ペイロード gzip → R2 PUT → Supabase に upsert）。サンプルのため本番向けハードニングが必要。</li>
<li><code>packages/FUSOU-WEB/src/workers/get_snapshot_worker.ts</code> — <code>GET /s/:token</code> 相当の Worker 実装（Supabase から metadata 取得 → R2 から payload 取得 → ETag / Cache-Control 応答）。JWKS を使った JWT 検証（署名検証）と鍵キャッシュを実装。</li>
<li><code>packages/FUSOU-APP/src/components/SnapshotViewer.tsx</code> — Solid 用の Snapshot ビューワーコンポーネント（<code>/s/:token</code> を fetch、If-None-Match / ETag を扱う）。</li>
<li><code>packages/FUSOU-APP/src/pages/viewer.tsx</code> — <code>/viewer/:token</code>（または <code>?token=</code>）で <code>SnapshotViewer</code> を表示するページ。</li>
<li><code>docs/scripts/test_get_snapshot_get.sh</code> — GET テスト用の curl スクリプト（マニュアルテスト用）。</li>
<li><code>docs/operations/manual-sync/manual_sync_runbook.md</code> — 運用ランブック（手動同期フロー、テスト手順の概要）。</li>
</ul>
<hr>
<p><strong>ルートとアクセス方法（まとめ）</strong></p>
<ul>
<li>アプリ内ビューワー: <code>/viewer/&lt;token&gt;</code> または <code>/viewer?token=&lt;token&gt;</code> にアクセスすると <code>SnapshotViewer</code> が読み込まれます（<code>packages/FUSOU-APP/src/pages/viewer.tsx</code>）。</li>
<li>実際のデータ取得 API: <code>GET /s/&lt;token&gt;</code> を Cloudflare Worker が処理します。Worker は Supabase の <code>fleets</code> メタデータを参照し、R2 から payload を取得して返します（ETag / 304 をサポート）。</li>
<li>スナップショットのアップロード API（例）: <code>POST /api/fleet/snapshot</code>（<code>packages/FUSOU-WEB/src/pages/api/fleet/snapshot.ts</code>）</li>
</ul>
<hr>
<p><strong>あなたが行う必要のある具体ステップ（優先度順）</strong></p>
<ol>
<li>Supabase にスキーマを適用する（必須）</li>
</ol>
<ul>
<li>ファイル: <code>docs/sql/supabase_fleets_schema.sql</code></li>
<li>例（ローカルから適用する場合）:<pre><code class="language-bash"><span class="hljs-built_in">export</span> SUPABASE_DB_URL=<span class="hljs-string">&quot;postgres://&lt;user&gt;:&lt;pass&gt;@&lt;host&gt;:5432/&lt;db&gt;&quot;</span>
psql <span class="hljs-string">&quot;<span class="hljs-variable">$SUPABASE_DB_URL</span>&quot;</span> -f docs/sql/supabase_fleets_schema.sql
</code></pre>
</li>
<li>Supabase コンソールを使う場合はスキーマ SQL を貼り付けて実行してください。</li>
<li>確認: テーブル <code>fleets</code> が作成され、RLS ポリシーが期待通りに有効化されていること。</li>
</ul>
<ol start="2">
<li>Cloudflare 環境（Pages/Workers）に環境変数と R2 バインディングを設定する（必須）</li>
</ol>
<ul>
<li>必要な環境変数（例）:
<ul>
<li><code>ASSET_PAYLOAD_BUCKET</code> — R2 バケット名（Worker の R2 バインディング名と一致）</li>
<li><code>SUPABASE_URL</code> — Supabase REST/GraphQL の URL</li>
<li><code>SUPABASE_SERVICE_KEY</code> — Supabase の service_role キー（機密）。Worker がメタデータ参照に使用します。権限は最小化検討。</li>
</ul>
</li>
<li>R2 のバインディングを Pages/Worker に追加（Cloudflare ダッシュボードまたは <code>wrangler</code> を利用）。</li>
</ul>
<ol start="3">
<li>Worker デプロイ（<code>GET /s/:token</code> を動かす）</li>
</ol>
<ul>
<li>オプション: 私が <code>wrangler.toml</code> テンプレートを追加できます（必要なら指示ください）。</li>
<li>デプロイ手順（wrangler 使用例）:<pre><code class="language-bash"><span class="hljs-comment"># 1. wrangler.toml を用意</span>
wrangler publish --<span class="hljs-built_in">env</span> production
</code></pre>
</li>
<li>デプロイ後、<code>/s/&lt;token&gt;</code> が期待どおり 200/304 を返すか curl で確認してください。</li>
</ul>
<ol start="4">
<li>アプリ側の <code>getAuthToken</code> を実装して、非公開スナップショットに対応する（必須 if private）</li>
</ol>
<ul>
<li><code>packages/FUSOU-APP/src/components/SnapshotViewer.tsx</code> の <code>getAuthToken</code> スタブを、あなたが使っている認証クライアント（例: <code>supabase-js</code>）からアクセストークンを返す実装に置き換えてください。</li>
<li>例（supabase-js の場合）:<pre><code class="language-ts"><span class="hljs-comment">// 例: supabaseClient.auth.getSession() の結果から access_token を返す</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">getAuthToken</span>(<span class="hljs-params"></span>) {
  <span class="hljs-keyword">const</span> { data } = <span class="hljs-keyword">await</span> supabase.<span class="hljs-property">auth</span>.<span class="hljs-title function_">getSession</span>();
  <span class="hljs-keyword">return</span> data?.<span class="hljs-property">session</span>?.<span class="hljs-property">access_token</span> ?? <span class="hljs-literal">null</span>;
}
</code></pre>
</li>
</ul>
<ol start="5">
<li>POST <code>/api/fleet/snapshot</code> の本番向けハードニング</li>
</ol>
<ul>
<li>実装済みはサンプルのため、以下を追加で実施してください:
<ul>
<li>最大受信サイズ制限（例: 5MB）とストリーミング受信の検討</li>
<li>idempotency-key or content-hash による重複 PUT の回避</li>
<li>レート制限（IP / API キーベース）、ログ出力</li>
<li>受信データのスキーマ検証（JSON schema）</li>
</ul>
</li>
</ul>
<ol start="6">
<li>E2E テスト（手動→自動化）</li>
</ol>
<ul>
<li>マニュアルテスト手順（短い手順）:
<ol>
<li>アプリ（または curl）で <code>POST /api/fleet/snapshot</code> にスナップショットを送る。</li>
<li>Supabase の <code>fleets</code> テーブルにメタが入っていることを確認する。</li>
<li><code>GET /s/&lt;token&gt;</code> を curl で叩き、200 と JSON が返ることを確認する。</li>
<li>返却ヘッダの <code>ETag</code> を控え、<code>If-None-Match</code> をつけて 304 が返るか確認する。</li>
</ol>
</li>
<li><code>docs/scripts/test_get_snapshot_get.sh</code> を手元で編集して、環境に合わせた URL をセットして実行してください。</li>
</ul>
<ol start="7">
<li>運用面（推奨）</li>
</ol>
<ul>
<li>保存容量と R2 のコスト管理：content-hash をキーにして重複排除し、古いバージョンの削除ポリシーを策定する。</li>
<li>監視とアラート: POST の失敗率、Supabase の 5xx、Worker のエラー率を監視。</li>
<li>定期バッチ（retention/prune）：cron（Cloudflare Workers Cron Triggers / 外部ジョブ）で古い R2 オブジェクトと DB メタを掃除。</li>
</ul>
<hr>
<p><strong>よくある問題と対処</strong></p>
<ul>
<li>304 が返らない: Worker の ETag 値がメタデータ（<code>version</code> / <code>hash</code>）と一致するか確認してください。Cache-Control とレスポンス ETag を同時に設定することで CDN が正しく機能します。</li>
<li>非公開スナップショットで 401/403 が出る: <code>getAuthToken</code> が正しいアクセストークンを返しているか、トークンの署名（RS256）と exp/nbf を確認してください。Worker は JWKS を使って署名検証を行います。</li>
<li>R2 に PUT できない: R2 のバインディング名と Worker の設定（<code>ASSET_PAYLOAD_BUCKET</code>）が一致しているか、権限があるか確認。</li>
</ul>
<hr>
<p>もしよければ、次に私が自動で行えること（選択）:</p>
<ul>
<li><code>wrangler.toml</code> のテンプレート作成と Worker デプロイ手順の追加（あなたのアカウント情報は不要なテンプレートのみ）。</li>
<li><code>getAuthToken</code> を <code>supabase-js</code> に合わせて実装するパッチを作成（あなたの auth ファイルパスを教えてください）。</li>
<li><code>POST</code> エンドポイントに受信サイズ制限と idempotency-key チェックを追加する改修。</li>
</ul>
<hr>
<p>ファイル: <code>docs/operations/manual-sync/implementation_and_next_steps.md</code>
上記ファイルを作成しました。次に何を自動化しますか？</p>

            <script async src="https://cdn.jsdelivr.net/npm/katex-copytex@latest/dist/katex-copytex.min.js"></script>
            
        </body>
        </html>