# アセットアップロードのリトライ機構

FUSOU アプリケーションでは、ネットワークの不安定さや認証トークンの期限切れなどにより、アセット（画像や音声ファイルなど）のアップロードが失敗することがあります。
これらの失敗したアップロードを確実に処理するために、**ローカル一時保存と自動リトライ機構**が実装されています。

## 概要

アップロード処理 (`asset_sync`) が失敗した場合、以下のフローで処理が行われます：

1.  **失敗の検知**: ネットワークエラー、認証エラー、またはサーバーエラー (5xx) を検知します。
2.  **ローカル保存**: アップロードしようとしたファイルデータとメタデータ（ターゲット URL、ヘッダー、コンテキスト情報）をローカルディスク (`PendingStore`) に保存します。
3.  **リトライ待機**: 保存されたファイルは、次回のトリガーイベントまで待機します。
4.  **リトライ実行**: トリガーイベント（認証トークンの更新など）が発生すると、バックグラウンドサービス (`UploadRetryService`) が起動し、保存されたファイルを順次再アップロードします。
5.  **完了/破棄**: アップロードが成功するとローカルファイルは削除されます。最大試行回数を超えた場合や有効期限が切れた場合は、ファイルは破棄されます。

## アーキテクチャ

### コンポーネント

- **PendingStore (`proxy-https/src/upload_pending.rs`)**:
  - 失敗したアップロードデータを管理するストレージ層です。
  - データは `.bin` (バイナリ) と `.json` (メタデータ) のペアとして保存されます。
  - 保存場所: ユーザーのローミングデータディレクトリ内の `pending_uploads` フォルダ。
- **UploadRetryService (`proxy-https/src/upload_retry.rs`)**:
  - 保留中のアップロードをスキャンし、再試行を行うバックグラウンドサービスです。
  - `asset_sync` のロジックを再利用してアップロードを行います。
  - 一度に 1 つのプロセスのみが実行されるように制御されています。
- **AssetSync (`proxy-https/src/asset_sync.rs`)**:
  - 通常のアセットアップロード処理を行います。
  - アップロード失敗時に `PendingStore` への保存を行うロジックが組み込まれています。
- **Tauri Command (`src-tauri/src/cmd/tauri_cmd.rs`)**:
  - フロントエンドからの認証情報更新 (`set_supabase_session`) をフックして、リトライサービスをトリガーします。

### データ構造

`PendingMeta` (JSON) には以下の情報が含まれます：

```json
{
  "id": "uuid-v4",
  "target_url": "https://api.example.com/upload",
  "headers": { ... },
  "created_at": 1678888888,
  "attempt_count": 0,
  "file_path": "path/to/uuid.bin",
  "context": "{ \"relative_path\": \"...\", \"key\": \"...\", \"file_size\": 12345 }"
}
```

## 設定

`configs.toml` の `[app.asset_sync.retry]` セクションで動作を制御できます。

```toml
[app.asset_sync.retry]
max_attempts = 5        # 最大リトライ回数
ttl_seconds = 86400     # 保存期間 (秒) - デフォルト 24時間
interval_seconds = 60   # (将来的な拡張用) 定期実行間隔
```

## 運用・トラブルシューティング

### リトライがトリガーされるタイミング

1.  **アプリ起動時**: アプリケーション起動時に `UploadRetryService` が初期化され、期限切れファイルのクリーンアップが行われます（現在は自動実行は設定されていませんが、構造上は可能です）。
2.  **認証トークン更新時**: ユーザーがログインするか、トークンがリフレッシュされ `set_supabase_session` コマンドが呼ばれると、リトライ処理が開始されます。

### 手動での確認

- **ログ確認**: `tracing` ログに `UploadRetryService` や `PendingStore` のアクティビティが出力されます。
  - `Saved pending upload due to ...`: 保存成功
  - `Starting upload retry process`: リトライ開始
  - `Successfully retried upload ...`: リトライ成功
- **ファイル確認**: OS のユーザーデータフォルダ（Windows なら `%APPDATA%\fusou-app\pending_uploads` など）を確認することで、保留中のファイルが存在するか確認できます。

### 制限事項

- **永続性**: アプリケーションをアンインストールしたり、データフォルダを削除すると、保留中のアップロードは失われます。
- **コンテキスト**: リトライ時は、失敗時の `AssetSyncContext` (相対パスやキー) を使用して再試行します。ファイルシステム上の元のファイルが移動・削除されていても、`.bin` ファイルが `PendingStore` にある限りリトライ可能です。
