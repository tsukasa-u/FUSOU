name = "fusou-workflow"
compatibility_date = "2024-10-22"
compatibility_flags = ["nodejs_compat"]

# Main entry point
main = "src/index.ts"

# ===== Environment Variables =====
# Note: Using dotenvx for encrypted environment variable management
# 1. Create .env file with plaintext values
# 2. Run: npx dotenvx encrypt
# 3. Retrieve DOTENV_PRIVATE_KEY from .env.keys
# 4. Set as Worker secret: wrangler secret put DOTENV_PRIVATE_KEY
# 5. The import '@dotenvx/dotenvx/config' in index.ts automatically loads encrypted values
# 6. Deploy with: npm run deploy (uses dotenvx run -- wrangler deploy)
# 
# How it works:
# - At deployment: dotenvx run wrapper decrypts and injects vars into build environment
# - At runtime: import '@dotenvx/dotenvx/config' loads from encrypted .env file
# - Variables are available in process.env (NOT Cloudflare bindings this.env)

# ===== Workflow definitions =====
[[workflows]]
name = "data-compaction-workflow"
binding = "DATA_COMPACTION"
class_name = "DataCompactionWorkflow"

# ===== R2 bucket bindings =====
[[r2_buckets]]
binding = "BATTLE_DATA_BUCKET"
bucket_name = "dev-kc-battle-data"
# location = "apac"  # Optional: Hint for primary location (Asia-Pacific for Japanese users)

# ===== Queue bindings =====
# Consumer: receives from main queue
[[queues.consumers]]
queue = "dev-kc-compaction-queue"
max_batch_size = 10
max_batch_timeout = 30
max_retries = 3
dead_letter_queue = "dev-kc-compaction-dlq"

# DLQ Handler: processes failed messages
[[queues.consumers]]
queue = "dev-kc-compaction-dlq"
max_batch_size = 5
max_batch_timeout = 60
max_retries = 1

# ===== CPU limit: 5 minutes per step =====
[limits]
cpu_ms = 300000

[observability]
enabled = false
head_sampling_rate = 1

[observability.logs]
enabled = true
head_sampling_rate = 1
persist = true
invocation_logs = true

[observability.traces]
enabled = false
persist = true
head_sampling_rate = 1

# ===== D1 database bindings =====
[[ d1_databases ]]
binding = "BATTLE_INDEX_DB"
database_name = "dev_kc_battle_index"
database_id = "700f4191-f93c-4db4-873d-d5fee9a901e3"