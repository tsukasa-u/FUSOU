name = "fusou-workflow"
compatibility_date = "2024-10-22"
compatibility_flags = ["nodejs_compat"]

# Main entry point
main = "src/index.ts"

# ===== Strict Spec Enforcement (vars) =====
[vars]
APPEND_STRICT = "true"
OUTPUT_KEY_NAME = "latest.parquet"

# ===== Environment Variables =====
# All configuration is now via D1 database
# Previous Supabase credentials have been removed

# ===== Workflow definitions =====
[[workflows]]
name = "data-compaction-workflow"
binding = "DATA_COMPACTION"
class_name = "DataCompactionWorkflow"

# ===== R2 bucket bindings =====
[[r2_buckets]]
binding = "BATTLE_DATA_BUCKET"
bucket_name = "dev-kc-battle-data"
# location = "apac"  # Optional: Hint for primary location (Asia-Pacific for Japanese users)

# ===== Queue bindings =====
# Consumer: receives from main queue
[[queues.consumers]]
queue = "dev-kc-compaction-queue"
max_batch_size = 10
max_batch_timeout = 30
max_retries = 3
dead_letter_queue = "dev-kc-compaction-dlq"

# DLQ Handler: processes failed messages
[[queues.consumers]]
queue = "dev-kc-compaction-dlq"
max_batch_size = 5
max_batch_timeout = 60
max_retries = 1

# ===== CPU limit: 5 minutes per step =====
[limits]
cpu_ms = 300000

[observability]
enabled = false
head_sampling_rate = 1

[observability.logs]
enabled = true
head_sampling_rate = 1
persist = true
invocation_logs = true

[observability.traces]
enabled = false
persist = true
head_sampling_rate = 1

# ===== D1 database bindings =====
[[ d1_databases ]]
binding = "BATTLE_INDEX_DB"
database_name = "dev_kc_battle_index"
database_id = "700f4191-f93c-4db4-873d-d5fee9a901e3"