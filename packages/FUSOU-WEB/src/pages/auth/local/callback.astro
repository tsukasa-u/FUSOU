---
import Layout from "../../../layouts/Layout.astro";
import Navigation from "../../../components/Navigation.astro";
import AlertBox from "../../../components/AlertBox.astro";
import WarningIcon from "../../../components/icons/WarningIcon.astro";
import CheckIcon from "../../../components/icons/CheckIcon.astro";
import { createSupabaseServerClient } from "@/utility/supabaseServer";

interface AuthProps {
  access_token: string;
  refresh_token: string;
  provider_token: string;
  provider_refresh_token: string;
  provider: string;
  expires_in: number;
}

const validateRedirectUrl = (url: string): boolean => {
  try {
    const parsedUrl = new URL(url);
    return (
      parsedUrl.protocol === "fusou:" ||
      parsedUrl.protocol === "http:" ||
      parsedUrl.protocol === "https:"
    );
  } catch {
    return false;
  }
};

let errorMessage: string | null = null;
let successMessage: string | null = null;
let authProps: AuthProps | null = null;
let errorRetryLink: string | null = null;
let errorSkipLink: string | null = null;

// Get the OAuth code from the query parameter
const code = Astro.url.searchParams.get("code");
const nextUrl = Astro.url.searchParams.get("next");

if (code && nextUrl && validateRedirectUrl(nextUrl)) {
  try {
    // Exchange the code for tokens
    const supabase = createSupabaseServerClient(Astro.cookies);
    const response = await fetch(
      `${import.meta.env.PUBLIC_SUPABASE_URL}/auth/v1/token?grant_type=authorization_code`,
      {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          apikey: import.meta.env.PUBLIC_SUPABASE_ANON_KEY,
        },
        body: JSON.stringify({
          code,
          grant_type: "authorization_code",
        }),
      }
    );

    if (!response.ok) {
      const error = await response.json();
      errorMessage =
        error.error_description || "Failed to exchange authorization code";
      errorRetryLink = "/auth/local/signin";
      errorSkipLink = "/";
    } else {
      const data = await response.json();
      const {
        access_token,
        refresh_token,
        provider_token,
        provider_refresh_token,
        expires_in,
      } = data;

      // Set the session cookies
      Astro.cookies.set("sb-access-token", access_token, {
        httpOnly: true,
        secure: import.meta.env.PROD,
        sameSite: "lax",
        maxAge: expires_in,
        path: "/",
      });

      Astro.cookies.set("sb-refresh-token", refresh_token, {
        httpOnly: true,
        secure: import.meta.env.PROD,
        sameSite: "lax",
        path: "/",
      });

      if (provider_token) {
        Astro.cookies.set("sb-provider-token", provider_token, {
          httpOnly: true,
          secure: import.meta.env.PROD,
          sameSite: "lax",
          maxAge: expires_in,
          path: "/",
        });
      }

      if (provider_refresh_token) {
        Astro.cookies.set("sb-provider-refresh-token", provider_refresh_token, {
          httpOnly: true,
          secure: import.meta.env.PROD,
          sameSite: "lax",
          path: "/",
        });
      }

      // Set the auth data for display and custom element
      authProps = {
        access_token,
        refresh_token,
        provider_token: provider_token || "",
        provider_refresh_token: provider_refresh_token || "",
        provider: "google",
        expires_in,
      };

      successMessage = "Successfully authenticated!";
    }
  } catch (error) {
    errorMessage = `Error: ${error instanceof Error ? error.message : String(error)}`;
    errorRetryLink = "/auth/local/signin";
    errorSkipLink = "/";
  }
} else {
  errorMessage = "Invalid authentication request";
  errorRetryLink = "/auth/local/signin";
  errorSkipLink = "/";
}
---

<Layout title="Authentication">
  <div class="min-h-screen flex items-center justify-center">
    <div class="w-full max-w-md">
      {
        authProps ? (
          <div class="bg-base-100 rounded-md p-6">
            <div class="flex items-center gap-2">
              <span class="flex-1 flex justify-end">
                <CheckIcon class="w-8 h-8" />
              </span>
              <span class="text-center text-2xl font-semibold">
                Authenticated
              </span>
              <span class="flex-1">
                <div class="h-8 w-8" />
              </span>
            </div>

            {successMessage && (
              <AlertBox type="info" title="Success">
                {successMessage}
              </AlertBox>
            )}

            <div class="mt-6 space-y-4">
              <div class="bg-base-200 p-4 rounded">
                <p class="text-xs text-base-content/70 mb-2">
                  Access Token (expires in {authProps.expires_in}s)
                </p>
                <div class="flex items-center gap-2">
                  <code class="text-xs break-all flex-1 select-all">
                    {authProps.access_token.substring(0, 50)}...
                  </code>
                  <button
                    class="btn btn-sm btn-ghost"
                    id="copy_access_token"
                    data-token={authProps.access_token}
                  >
                    Copy
                  </button>
                </div>
              </div>

              <div class="bg-base-200 p-4 rounded">
                <p class="text-xs text-base-content/70 mb-2">Refresh Token</p>
                <div class="flex items-center gap-2">
                  <code class="text-xs break-all flex-1 select-all">
                    {authProps.refresh_token.substring(0, 50)}...
                  </code>
                  <button
                    class="btn btn-sm btn-ghost"
                    id="copy_refresh_token"
                    data-token={authProps.refresh_token}
                  >
                    Copy
                  </button>
                </div>
              </div>

              {authProps.provider_token && (
                <div class="bg-base-200 p-4 rounded">
                  <p class="text-xs text-base-content/70 mb-2">
                    Provider Token
                  </p>
                  <div class="flex items-center gap-2">
                    <code class="text-xs break-all flex-1 select-all">
                      {authProps.provider_token.substring(0, 50)}...
                    </code>
                    <button
                      class="btn btn-sm btn-ghost"
                      id="copy_provider_token"
                      data-token={authProps.provider_token}
                    >
                      Copy
                    </button>
                  </div>
                </div>
              )}
            </div>

            <div class="mt-6 text-center text-sm text-base-content/70">
              <p>Tokens are being exchanged with the desktop application...</p>
            </div>
          </div>
        ) : (
          <div class="bg-base-100 rounded-md p-6">
            <div class="flex items-center gap-2">
              <span class="flex-1 flex justify-end">
                <WarningIcon class="w-8 h-8" />
              </span>
              <span class="text-center text-2xl font-semibold">
                Authentication Failed
              </span>
              <span class="flex-1">
                <div class="h-8 w-8" />
              </span>
            </div>

            {errorMessage && (
              <AlertBox type="error" title="Error">
                {errorMessage}
              </AlertBox>
            )}

            <div class="mt-6 flex flex-col gap-3">
              {errorRetryLink && (
                <a href={errorRetryLink} class="btn btn-primary w-full">
                  Try Again
                </a>
              )}
              {errorSkipLink && (
                <a href={errorSkipLink} class="btn btn-ghost w-full">
                  Go Back
                </a>
              )}
            </div>

            <div class="mt-6 text-center text-sm text-base-content/70">
              <p>
                If you continue to experience issues, please contact support.
              </p>
            </div>
          </div>
        )
      }
    </div>
  </div>

  <Navigation />

  {authProps && <astro-data-auth_props {...authProps} />}

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      // Handle copy buttons
      document.querySelectorAll("[id^='copy_']").forEach((button) => {
        button.addEventListener("click", async (event) => {
          const token = (event.target as HTMLButtonElement).dataset.token;
          if (token) {
            try {
              await navigator.clipboard.writeText(token);
              const originalText = (event.target as HTMLButtonElement).textContent;
              (event.target as HTMLButtonElement).textContent = "Copied!";
              setTimeout(() => {
                (event.target as HTMLButtonElement).textContent = originalText;
              }, 2000);
            } catch (err) {
              console.error("Failed to copy token:", err);
            }
          }
        });
      });

      // Handle custom element for auth props
      const authElement = document.querySelector("astro-data-auth_props");
      if (authElement) {
        const authProps = {
          access_token: authElement.getAttribute("access_token"),
          refresh_token: authElement.getAttribute("refresh_token"),
          provider_token: authElement.getAttribute("provider_token"),
          provider_refresh_token: authElement.getAttribute("provider_refresh_token"),
          provider: authElement.getAttribute("provider"),
          expires_in: parseInt(
            authElement.getAttribute("expires_in") || "0",
            10
          ),
        };

        // Send auth data to parent window if in iframe/popup
        if (window.opener) {
          window.opener.postMessage(
            {
              type: "AUTH_RESPONSE",
              data: authProps,
            },
            "*"
          );

          // Close window after a delay to allow message delivery
          setTimeout(() => {
            window.close();
          }, 1000);
        }

        // Also handle custom protocol for desktop app
        const customProtocolUrl = `fusou://auth?access_token=${encodeURIComponent(
          authProps.access_token || ""
        )}&refresh_token=${encodeURIComponent(
          authProps.refresh_token || ""
        )}&provider_token=${encodeURIComponent(
          authProps.provider_token || ""
        )}&provider_refresh_token=${encodeURIComponent(
          authProps.provider_refresh_token || ""
        )}&provider=${encodeURIComponent(
          authProps.provider || "google"
        )}&expires_in=${authProps.expires_in || 0}`;

        // Try to navigate with custom protocol
        setTimeout(() => {
          window.location.href = customProtocolUrl;
        }, 500);
      }
    });
  </script>
</Layout>

<style>
  astro-data-auth_props {
    display: none;
  }
</style>
