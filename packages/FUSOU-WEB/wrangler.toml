# Cloudflare Pages configuration for FUSOU-WEB
name = "fusou"
compatibility_date = "2024-01-01"
pages_build_output_dir = "dist"

# ===== Environment Variables =====
# Note: Using dotenvx for encrypted environment variable management
# Development:
#   - dotenvx run commands in package.json automatically load .env
# Production (Cloudflare Pages):
#   1. Create .env.production with production values
#   2. Run: npx dotenvx encrypt -f .env.production
#   3. In Cloudflare Pages Dashboard → Settings → Environment Variables → Production
#      Add: DOTENV_PRIVATE_KEY = <value from .env.production.keys>
# Do NOT add secrets to [vars] section - use dotenvx encryption instead

# ===== Service Bindings =====
# Connect to separate Workers
[[services]]
binding = "COMPACTION_WORKFLOW"
service = "fusou-workflow"

# ===== R2 Bucket Bindings =====
[[r2_buckets]]
binding = "ASSET_SYNC_BUCKET"
bucket_name = "dev-kc-assets"
# location = "apac"  # Optional: Hint for primary location (Asia-Pacific for Japanese users)

[[r2_buckets]]
binding = "FLEET_SNAPSHOT_BUCKET"
bucket_name = "dev-kc-fleets"
# location = "apac"  # Optional: Hint for primary location (Asia-Pacific for Japanese users)

[[r2_buckets]]
binding = "BATTLE_DATA_BUCKET"
bucket_name = "dev-kc-battle-data"
# location = "apac"  # Optional: Hint for primary location (Asia-Pacific for Japanese users)

[[ d1_databases ]]
binding = "ASSET_INDEX_DB"
database_name = "dev_kc_asset_index"
database_id = "c625d190-44b7-4a80-85fe-6fddbba64248"

[[ d1_databases ]]
binding = "BATTLE_INDEX_DB"
database_name = "dev_kc_battle_index"
database_id = "700f4191-f93c-4db4-873d-d5fee9a901e3"

# ===== Queue Bindings =====
# Producer binding (send messages from Pages)
[[queues.producers]]
queue = "dev-kc-compaction-queue"
binding = "COMPACTION_QUEUE"

# DLQ for monitoring
[[queues.producers]]
queue = "dev-kc-compaction-dlq"
binding = "COMPACTION_DLQ"

# Consumer binding (process messages from the queue)
[[queues.consumers]]
queue = "dev-kc-compaction-queue"
max_batch_size = 10
max_batch_timeout = 30
max_retries = 3
dead_letter_queue = "dev-kc-compaction-dlq"

# ===== Scheduled cron triggers =====
# Note: Cloudflare Pages does not support scheduled functions via wrangler.toml
# Alternative approaches:
#
# Option 1: External Cron Service (Recommended)
#   Use GitHub Actions, Cloudflare Workers Cron, or other cron services to call:
#   POST https://your-site.pages.dev/api/compaction/trigger-scheduled
#
# Option 2: Cloudflare Workers Cron (Separate Worker)
#   Create a separate Worker with cron trigger that calls the endpoint
#
# Option 3: Manual Trigger
#   Call the endpoint manually when needed for testing
