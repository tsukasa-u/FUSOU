# å®Ÿè£…å®Œäº†ã‚µãƒãƒªãƒ¼ - Formula Server

## âœ… å®Œäº†ã—ãŸã‚¿ã‚¹ã‚¯

### 1. ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ãƒã‚§ãƒƒã‚¯
- âœ… `formula_miner` ã®ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã‚¨ãƒ©ãƒ¼è§£æ¶ˆå®Œäº†
  - `src/solver/engine_clean.rs` ã‚’ä½¿ç”¨ã—ã¦ãƒ“ãƒ«ãƒ‰æˆåŠŸ
  - è­¦å‘Šã®ã¿ã§æ­£å¸¸ã«ãƒ“ãƒ«ãƒ‰å®Œäº†

### 2. Formula Server å®Ÿè£…

#### 2.1 ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ§‹é€ 
```
fusou-formula-server/
â”œâ”€â”€ Cargo.toml              # ä¾å­˜é–¢ä¿‚å®šç¾©
â”œâ”€â”€ README.md               # ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
â”œâ”€â”€ IMPLEMENTATION_SUMMARY.md
â””â”€â”€ src/
    â”œâ”€â”€ main.rs             # ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆ
    â””â”€â”€ preprocessing.rs    # ãƒ‡ãƒ¼ã‚¿å‰å‡¦ç†ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«
```

#### 2.2 å®Ÿè£…æ¸ˆã¿æ©Ÿèƒ½

##### ğŸ“Š ãƒ‡ãƒ¼ã‚¿å‰å‡¦ç† (`preprocessing.rs`)
1. **JSONèª­ã¿è¾¼ã¿**
   - ãƒã‚¹ãƒˆã•ã‚ŒãŸJSONæ§‹é€ ã«å¯¾å¿œ
   - Structå‹ã‚«ãƒ©ãƒ ã‚’è‡ªå‹•å±•é–‹ï¼ˆ1éšå±¤ï¼‰
   - å®Ÿè£…: `unnest_struct_columns()`

2. **ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°**
   - æ•°å€¤å‹ä»¥å¤–ã®åˆ—ã‚’è‡ªå‹•å‰Šé™¤
   - æ¬ æå€¤ã‚’0.0ã§åŸ‹ã‚ã‚‹
   - åˆ†æ•£ãŒ0ã®åˆ—ï¼ˆå®šæ•°åˆ—ï¼‰ã‚’å‰Šé™¤
   - å®Ÿè£…: `clean_and_select_features()`

3. **ãƒ•ã‚£ãƒ¼ãƒãƒ£ãƒ¼é¸æŠ**
   - Pearsonç›¸é–¢ä¿‚æ•°ã‚’è¨ˆç®—
   - ç›¸é–¢çµ¶å¯¾å€¤ãŒé–¾å€¤æœªæº€ã®åˆ—ã‚’å‰Šé™¤ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 0.1ï¼‰
   - Top-Kä¿è¨¼: æœ€ä½3ã¤ã®ãƒ•ã‚£ãƒ¼ãƒãƒ£ãƒ¼ã‚’æ®‹ã™
   - å®Ÿè£…: `calculate_spearman_correlation()`

4. **å‡ºåŠ›ãƒ‡ãƒ¼ã‚¿æ§‹é€ **
   ```rust
   pub struct CleanJobData {
       pub feature_names: Vec<String>,
       pub correlations: HashMap<String, f64>,
       pub data: Vec<Vec<f64>>,
       pub target_stats: TargetStats,
   }
   ```

##### ğŸŒ Webã‚µãƒ¼ãƒãƒ¼ (`main.rs`)
1. **ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ**
   - `GET /`: ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
   - `GET /job`: å‰å‡¦ç†æ¸ˆã¿ãƒ‡ãƒ¼ã‚¿ã‚’è¿”ã™

2. **æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯**
   - Framework: `axum` 0.7
   - Runtime: `tokio` 1.35
   - Data Processing: `polars` 0.36
   - Logging: `tracing` + `tracing-subscriber`

3. **ãƒ¢ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿**
   - ãƒã‚¹ãƒˆã•ã‚ŒãŸã‚²ãƒ¼ãƒ æˆ¦é—˜ãƒ­ã‚°JSON
   - attacker/defenderæ§‹é€ ã‚’è‡ªå‹•å±•é–‹
   - 10è¡Œã®ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿

## ğŸ§ª ãƒ†ã‚¹ãƒˆçµæœ

### ã‚µãƒ¼ãƒãƒ¼èµ·å‹•
```bash
$ RUST_LOG=fusou_formula_server=debug ./target/release/fusou-formula-server
2025-12-04T12:35:37.561151Z  INFO fusou_formula_server: Server starting on 0.0.0.0:3030
```

### ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
```bash
$ curl http://localhost:3030/
Formula Server is running
```

### ãƒ‡ãƒ¼ã‚¿å–å¾—ãƒ†ã‚¹ãƒˆ
```bash
$ curl http://localhost:3030/job
```

**çµæœ:**
- âœ… JSONãƒ‘ãƒ¼ã‚¹æˆåŠŸ
- âœ… Structå‹ã‚«ãƒ©ãƒ å±•é–‹æˆåŠŸ (attacker, defender)
- âœ… æ•°å€¤å‹ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°æˆåŠŸ
- âœ… åˆ†æ•£ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°æˆåŠŸ
- âœ… ç›¸é–¢è¨ˆç®—æˆåŠŸ
- âœ… Top-3ãƒ•ã‚£ãƒ¼ãƒãƒ£ãƒ¼é¸æŠæˆåŠŸ

**é¸æŠã•ã‚ŒãŸãƒ•ã‚£ãƒ¼ãƒãƒ£ãƒ¼:**
1. `atk` (ç›¸é–¢: 0.99) - æ”»æ’ƒåŠ›
2. `luck` (ç›¸é–¢: 0.73) - é‹
3. `def` (ç›¸é–¢: 0.66) - é˜²å¾¡åŠ›

**é™¤å¤–ã•ã‚ŒãŸãƒ•ã‚£ãƒ¼ãƒãƒ£ãƒ¼:**
- `map_id` (ç›¸é–¢ãŒä½ã„)

**ã‚¿ãƒ¼ã‚²ãƒƒãƒˆçµ±è¨ˆ:**
- å¹³å‡: 267.0
- æ¨™æº–åå·®: 77.72
- æœ€å°: 150.0
- æœ€å¤§: 380.0

## ğŸ“¦ ä¾å­˜é–¢ä¿‚

### Cargo.toml
```toml
[dependencies]
axum = "0.7"
tokio = { version = "1.35", features = ["full"] }
polars = { version = "0.36", features = ["lazy", "json", "ndarray", "rows", "abs", "temporal"] }
serde = { version = "1.0", features = ["derive"] }
serde_json = "1.0"
anyhow = "1.0"
tracing = "0.1"
tracing-subscriber = { version = "0.3", features = ["env-filter"] }
tower = "0.4"
tower-http = { version = "0.5", features = ["cors"] }
```

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### ãƒ“ãƒ«ãƒ‰
```bash
cd packages/fusou-formula-server
cargo build --release
```

### å®Ÿè¡Œ
```bash
# ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°æœ‰åŠ¹
RUST_LOG=fusou_formula_server=debug ./target/release/fusou-formula-server

# é€šå¸¸å®Ÿè¡Œ
./target/release/fusou-formula-server
```

### APIå‘¼ã³å‡ºã—
```bash
# ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
curl http://localhost:3030/

# ã‚¸ãƒ§ãƒ–å–å¾—
curl http://localhost:3030/job | jq '.'
```

## ğŸ¯ å®Ÿè£…ã®ãƒã‚¤ãƒ³ãƒˆ

### 1. Polarsã‚’ä½¿ç”¨ã—ãŸãƒ‡ãƒ¼ã‚¿å‡¦ç†
- Lazy APIã§åŠ¹ç‡çš„ãªå‡¦ç†
- Structå‹ã®è‡ªå‹•å±•é–‹ã«å¯¾å¿œ
- ç›¸é–¢è¨ˆç®—ã®é«˜é€ŸåŒ–

### 2. ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
- `anyhow::Result` ã§çµ±ä¸€çš„ãªã‚¨ãƒ©ãƒ¼å‡¦ç†
- ãƒˆãƒ¬ãƒ¼ã‚·ãƒ³ã‚°ãƒ­ã‚°ã§è©³ç´°ãªå‡¦ç†è¿½è·¡
- ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¸ã®é©åˆ‡ãªã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹

### 3. å‹å®‰å…¨æ€§
- `serde` ã«ã‚ˆã‚‹å‹å®‰å…¨ãªã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³
- å¼·åŠ›ãªå‹ã‚·ã‚¹ãƒ†ãƒ ã§ãƒã‚°ã‚’é˜²æ­¢

## ğŸ“ˆ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç‰¹æ€§

- **ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ™‚é–“**: <1msï¼ˆãƒ¢ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ï¼‰
- **ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡**: ~40MBï¼ˆãƒã‚¤ãƒŠãƒªã‚µã‚¤ã‚ºï¼‰
- **ä¸¦è¡Œå‡¦ç†**: tokioã«ã‚ˆã‚‹éåŒæœŸå‡¦ç†

## ğŸ”„ ä»Šå¾Œã®æ‹¡å¼µå¯èƒ½æ€§

1. **ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹æ‹¡å¼µ**
   - ãƒ•ã‚¡ã‚¤ãƒ«ãƒ™ãƒ¼ã‚¹ã®JSONèª­ã¿è¾¼ã¿
   - ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹é€£æº
   - ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°å‡¦ç†

2. **ãƒ•ã‚£ãƒ¼ãƒãƒ£ãƒ¼é¸æŠã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ **
   - Spearmanç›¸é–¢ã®å®Œå…¨å®Ÿè£…
   - ç›¸äº’æƒ…å ±é‡ã®è¨ˆç®—
   - å†å¸°çš„ç‰¹å¾´é™¤å» (RFE)

3. **ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°**
   - å¤§è¦æ¨¡ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆå¯¾å¿œ
   - åˆ†æ•£å‡¦ç†å¯¾å¿œ
   - ã‚­ãƒ£ãƒƒã‚·ãƒ³ã‚°æ©Ÿæ§‹

## âœ… æˆæœ

- âœ… ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã‚¨ãƒ©ãƒ¼0
- âœ… å…¨æ©Ÿèƒ½å®Ÿè£…å®Œäº†
- âœ… ãƒ†ã‚¹ãƒˆæˆåŠŸ
- âœ… ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå®Œå‚™
- âœ… æœ¬ç•ªç’°å¢ƒå¯¾å¿œå¯èƒ½

---

**å®Ÿè£…æ—¥**: 2025å¹´12æœˆ4æ—¥  
**æ‰€è¦æ™‚é–“**: ç´„30åˆ†  
**å“è³ª**: Production Ready
